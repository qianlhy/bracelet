# 微信支付公钥配置说明

## 概述

微信支付公钥是微信支付推出的新版验签机制，用于替代平台证书验签。使用微信支付公钥可以：
1. **验证微信支付应答的签名**：确保返回数据来自微信支付官方
2. **验证回调通知的签名**：确保支付成功/退款通知来自微信支付
3. **加密敏感信息**：上送敏感信息给微信支付时使用公钥加密

## 重要概念区分

### APIv3密钥 vs 微信支付公钥

| 项目 | APIv3密钥 | 微信支付公钥 |
|------|----------|------------|
| **用途** | AES解密回调数据 | RSA验证签名 |
| **格式** | 32位字符串 | PEM格式公钥文件 |
| **示例** | `YourAPIv3Key32CharactersLong12` | `1734348120_wxp_pub.pem` |
| **配置项** | `apiV3Key` | `weChatPayPublicKeyId` + `weChatPayPublicKeyPath` |
| **获取方式** | 商户平台设置 | 商户平台申请下载 |

**常见错误**：将公钥ID（如`PUB_KEY_ID_xxx`）配置到`apiV3Key`字段！

## 配置步骤

### 1. 获取APIv3密钥（必须）

1. 登录[微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心** -> **API安全** -> **APIv3密钥**
3. 点击 **设置密钥**，设置32位字符串（建议使用随机生成）
4. **重要**：设置后无法查看，请妥善保存

**配置示例**：
```yaml
apiV3Key: YourAPIv3Key32CharactersLong12  # 替换为您设置的32位密钥
```

### 2. 获取微信支付公钥（推荐）

1. 登录[微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心** -> **API安全** -> **微信支付公钥**
3. 点击 **申请公钥**
4. 下载公钥文件（文件名类似：`1734348120_wxp_pub.pem`）
5. 查看 **公钥ID**（格式：`PUB_KEY_ID_xxxxxx`）

**配置步骤**：
1. 将下载的公钥文件放到项目 `certs` 文件夹
2. 配置公钥ID和公钥文件路径：

```yaml
weChatPayPublicKeyId: PUB_KEY_ID_0117343481202025120300381767000202
weChatPayPublicKeyPath: d:/work_boss/BraceletUniapp/diy-bracelet-backend-code/certs/1734348120_wxp_pub.pem
```

### 3. 商户API证书配置（必须）

商户API证书用于商户请求签名，必须配置。

1. 登录[微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **账户中心** -> **API安全** -> **API证书**
3. 申请并下载API证书（包含3个文件）
4. 将证书文件放到项目 `certs` 文件夹

**配置示例**：
```yaml
mchSerialNo: 5631D4B837843E6E770BE80D00AFC8B86B38A97B
privateKeyFilePath: d:/work_boss/BraceletUniapp/diy-bracelet-backend-code/certs/apiclient_key.pem
```

## 完整配置示例

```yaml
sky:
  wechat:
    # 基础配置
    appid: wxcfa41f1d1bc716a8
    secret: 18166e4cdca2a2d1fbfa2fa4db1f6bf4
    mchid: 1734348120
    
    # 商户API证书配置（用于商户请求签名）
    mchSerialNo: 5631D4B837843E6E770BE80D00AFC8B86B38A97B
    privateKeyFilePath: d:/work_boss/BraceletUniapp/diy-bracelet-backend-code/certs/apiclient_key.pem
    
    # APIv3密钥（用于AES解密）
    apiV3Key: YourAPIv3Key32CharactersLong12  # 请替换为您的32位密钥
    
    # 微信支付公钥（用于RSA验签，推荐）
    weChatPayPublicKeyId: PUB_KEY_ID_0117343481202025120300381767000202
    weChatPayPublicKeyPath: d:/work_boss/BraceletUniapp/diy-bracelet-backend-code/certs/1734348120_wxp_pub.pem
    
    # 平台证书（旧版验签方式，兼容）
    weChatPayCertFilePath: d:/work_boss/BraceletUniapp/diy-bracelet-backend-code/certs/apiclient_cert.pem
    
    # 回调地址
    notifyUrl: http://491715ee.r7.cpolar.cn/notify/paySuccess
    refundNotifyUrl: http://491715ee.r7.cpolar.cn/notify/refundSuccess
```

## 验签方式选择

### 方案A：使用微信支付公钥（推荐）

**优点**：
- 微信官方推荐的新方案
- 公钥长期有效，无需频繁更新
- 性能更好

**配置要求**：
```yaml
weChatPayPublicKeyId: PUB_KEY_ID_xxx  # 必须
weChatPayPublicKeyPath: xxx_wxp_pub.pem  # 必须
weChatPayCertFilePath: xxx  # 可选（兼容）
```

### 方案B：使用平台证书（旧方案）

**缺点**：
- 平台证书有效期较短，需要定期更新
- SDK会自动下载更新证书（需要网络）

**配置要求**：
```yaml
weChatPayCertFilePath: apiclient_cert.pem  # 必须
```

## 常见问题

### Q1: APIv3密钥设置后忘记了怎么办？

**答**：APIv3密钥设置后无法查看，只能重新设置。重新设置后需要同步更新配置文件。

### Q2: 提示"商户API证书序列号格式错误"

**答**：证书序列号必须是纯十六进制字符串（大写字母A-F + 数字0-9），不要包含冒号或其他分隔符。

正确格式：`5631D4B837843E6E770BE80D00AFC8B86B38A97B`  
错误格式：`56:31:D4:B8:37:84:3E:6E:77:0B:E8:0D:00:AF:C8:B8:6B:38:A9:7B`

### Q3: 公钥ID和APIv3密钥有什么区别？

**答**：
- **公钥ID**：格式为`PUB_KEY_ID_xxx`，用于标识微信支付公钥，配置到`weChatPayPublicKeyId`
- **APIv3密钥**：32位字符串，用于AES解密，配置到`apiV3Key`

**绝对不要混淆这两个配置！**

### Q4: 内网穿透工具推荐

开发环境需要公网回调地址，推荐使用：
- [cpolar](https://www.cpolar.com/) - 国内稳定，有免费套餐
- [ngrok](https://ngrok.com/) - 国际知名，需要科学上网
- [natapp](https://natapp.cn/) - 国内服务，速度快

## 相关文档

- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [微信支付公钥产品说明](https://pay.weixin.qq.com/doc/v3/merchant/4012925323)
- [如何使用微信支付公钥验签](https://pay.weixin.qq.com/doc/v3/merchant/4013053249)
- [如何使用微信支付公钥加密敏感字段](https://pay.weixin.qq.com/doc/v3/merchant/4013053257)

## 检查清单

配置完成后，请检查以下项目：

- [ ] `appid` 和 `secret` 已从微信公众平台获取
- [ ] `mchid` 商户号已确认
- [ ] 商户API证书已下载并放在 `certs` 目录（`apiclient_key.pem`、`apiclient_cert.pem`）
- [ ] `mchSerialNo` 证书序列号已从商户平台复制（纯十六进制格式）
- [ ] `apiV3Key` 已在商户平台设置，并配置为真实的32位密钥
- [ ] 微信支付公钥已申请下载并配置（推荐）
- [ ] 回调URL已配置为公网可访问地址（开发环境使用内网穿透）
- [ ] 所有证书文件路径使用正斜杠 `/`（Windows环境）

配置完成后，启动项目测试支付功能！
